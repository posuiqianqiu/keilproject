C51 COMPILER V9.54   MATRIXKEY                                                             10/02/2025 16:36:09 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MATRIXKEY
OBJECT MODULE PLACED IN .\Objects\MatrixKey.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE MatrixKey.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\Ma
                    -trixKey.lst) TABS(2) OBJECT(.\Objects\MatrixKey.obj)

line level    source

   1          #include "matrixkey.h"
   2          #include <intrins.h>
   3          
   4          // 按键显示缓冲区
   5          unsigned char KeyDisplayValue = 0;
   6          
   7          /**
   8           * @brief 简单延时函数
   9           * @param t 延时时间
  10           * @return 无
  11           */
  12          void Key_Delay(unsigned int t)
  13          {
  14   1          while(t--);
  15   1      }
  16          
  17          /**
  18           * @brief 矩阵键盘初始化
  19           * @param 无
  20           * @return 无
  21           */
  22          void MatrixKey_Init(void)
  23          {
  24   1          KEY_PORT = 0xFF;  // 初始化P1口为高电平
  25   1          KeyDisplayValue = 0; // 初始化显示值为0
  26   1      }
  27          
  28          /**
  29           * @brief 行扫描法检测按键
  30           * @param 无
  31           * @return 按键值 (1-16) 或 0(无按键)
  32           * @说明 修正行列映射，确保左上角S1对应01
  33           */
  34          unsigned char MatrixKey_RowScan(void)
  35          {
  36   1          unsigned char row, col;
  37   1          unsigned char key_value = 0;
  38   1          unsigned char temp;
  39   1          
  40   1          // 行扫描：逐行输出低电平
  41   1          for(row = 0; row < 4; row++)
  42   1          {
  43   2              // 当前行输出0，其他行输出1
  44   2              // 行线在P1.7-P1.4，所以左移(4+row)位
  45   2              KEY_PORT = (0xFF & ~(1 << (4 + row)));
  46   2              
  47   2              // 短暂延时，等待信号稳定
  48   2              _nop_();
  49   2              _nop_();
  50   2              
  51   2              // 读取列线状态（低4位 P1.3-P1.0）
  52   2              temp = KEY_PORT & 0x0F;
  53   2              
  54   2              // 检查哪一列为低电平
C51 COMPILER V9.54   MATRIXKEY                                                             10/02/2025 16:36:09 PAGE 2   

  55   2              if(temp != 0x0F)  // 有列线被拉低
  56   2              {
  57   3                  // 确定具体的列
  58   3                  for(col = 0; col < 4; col++)
  59   3                  {
  60   4                      if(!(temp & (1 << col)))
  61   4                      {
  62   5                          key_value = (3 - row) * 4 + (3 - col) + 1;
  63   5                          
  64   5                          // 恢复端口状态
  65   5                          KEY_PORT = 0xFF;
  66   5                          return key_value;
  67   5                      }
  68   4                  }
  69   3              }
  70   2          }
  71   1          
  72   1          // 恢复端口状态
  73   1          KEY_PORT = 0xFF;
  74   1          return 0;  // 无按键按下
  75   1      }
  76          
  77          /**
  78           * @brief 等待按键释放
  79           * @param 无
  80           * @return 无
  81           */
  82          void MatrixKey_WaitRelease(void)
  83          {
  84   1          // 等待所有按键释放
  85   1          while(MatrixKey_RowScan() != 0)
  86   1          {
  87   2              Key_Delay(100);
  88   2          }
  89   1          Key_Delay(100); // 额外延时确保稳定
  90   1      }
  91          
  92          /**
  93           * @brief 获取按键并处理显示
  94           * @param 无
  95           * @return 无
  96           * @说明 主功能函数：按下无现象，松手显示对应编号
  97           */
  98          void MatrixKey_ProcessKey(void)
  99          {
 100   1          static unsigned char last_key = 0;
 101   1          unsigned char current_key;
 102   1          
 103   1          // 检测当前按键状态
 104   1          current_key = MatrixKey_RowScan();
 105   1          
 106   1          if(current_key != 0)
 107   1          {
 108   2              // 有按键按下，记录按键值但不显示
 109   2              last_key = current_key;
 110   2          }
 111   1          else if(last_key != 0)
 112   1          {
 113   2              // 按键从按下变为释放，显示对应编号
 114   2              KeyDisplayValue = last_key;
 115   2              
 116   2              // 重置last_key，避免重复触发
C51 COMPILER V9.54   MATRIXKEY                                                             10/02/2025 16:36:09 PAGE 3   

 117   2              last_key = 0;
 118   2              
 119   2              // 确保按键完全释放
 120   2              MatrixKey_WaitRelease();
 121   2          }
 122   1      }
 123          
 124          /**
 125           * @brief 获取要显示的按键值
 126           * @param 无
 127           * @return 要显示的按键编号 (0-16)
 128           * @说明 返回0表示无显示，1-16表示对应按键编号
 129           */
 130          unsigned char MatrixKey_GetDisplayValue(void)
 131          {
 132   1          unsigned char temp = KeyDisplayValue;
 133   1          KeyDisplayValue = 0; // 读取后清零，避免重复显示
 134   1          return temp;
 135   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    162    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
