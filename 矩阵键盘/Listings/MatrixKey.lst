C51 COMPILER V9.54   MATRIXKEY                                                             10/02/2025 14:02:12 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MATRIXKEY
OBJECT MODULE PLACED IN .\Objects\MatrixKey.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE MatrixKey.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\Ma
                    -trixKey.lst) TABS(2) OBJECT(.\Objects\MatrixKey.obj)

line level    source

   1          #include "matrixkey.h"
   2          #include <intrins.h>
   3          
   4          // 按键显示缓冲区
   5          unsigned char KeyDisplayValue = 0;
   6          
   7          /**
   8           * @brief 简单延时函数
   9           * @param t 延时时间
  10           * @return 无
  11           */
  12          void Key_Delay(unsigned int t)
  13          {
  14   1          while(t--);
  15   1      }
  16          
  17          /**
  18           * @brief 矩阵键盘初始化
  19           * @param 无
  20           * @return 无
  21           */
  22          void MatrixKey_Init(void)
  23          {
  24   1          KEY_PORT = 0xFF;  // 初始化P1口为高电平
  25   1          KeyDisplayValue = 0; // 初始化显示值为0
  26   1      }
  27          
  28          /**
  29           * @brief 行扫描法检测按键
  30           * @param 无
  31           * @return 按键值 (1-16) 或 0(无按键)
  32           * @说明 修正行列映射，确保左上角S1对应01
  33           */
  34          unsigned char MatrixKey_RowScan(void)
  35          {
  36   1          unsigned char row, col;
  37   1          unsigned char key_value = 0;
  38   1          unsigned char temp;
  39   1          
  40   1          // 行扫描：逐行输出低电平
  41   1          for(row = 0; row < 4; row++)
  42   1          {
  43   2              // 当前行输出0，其他行输出1
  44   2              // 行线在P1.7-P1.4，所以左移(4+row)位
  45   2              KEY_PORT = (0xFF & ~(1 << (4 + row)));
  46   2              
  47   2              // 短暂延时，等待信号稳定
  48   2              _nop_();
  49   2              _nop_();
  50   2              
  51   2              // 读取列线状态（低4位 P1.3-P1.0）
  52   2              temp = KEY_PORT & 0x0F;
  53   2              
  54   2              // 检查哪一列为低电平
C51 COMPILER V9.54   MATRIXKEY                                                             10/02/2025 14:02:12 PAGE 2   

  55   2              if(temp != 0x0F)  // 有列线被拉低
  56   2              {
  57   3                  // 确定具体的列
  58   3                  for(col = 0; col < 4; col++)
  59   3                  {
  60   4                      if(!(temp & (1 << col)))
  61   4                      {
  62   5                          // 关键修正：调整行列映射关系
  63   5                          // 左上角S1应该是行0列0，对应01
  64   5                          // 原来的计算：key_value = row * 4 + col + 1;
  65   5                          // 新的计算：需要调整行列顺序
  66   5                          key_value = (3 - row) * 4 + (3 - col) + 1;
  67   5                          
  68   5                          // 恢复端口状态
  69   5                          KEY_PORT = 0xFF;
  70   5                          return key_value;
  71   5                      }
  72   4                  }
  73   3              }
  74   2          }
  75   1          
  76   1          // 恢复端口状态
  77   1          KEY_PORT = 0xFF;
  78   1          return 0;  // 无按键按下
  79   1      }
  80          
  81          /**
  82           * @brief 等待按键释放
  83           * @param 无
  84           * @return 无
  85           */
  86          void MatrixKey_WaitRelease(void)
  87          {
  88   1          // 等待所有按键释放
  89   1          while(MatrixKey_RowScan() != 0)
  90   1          {
  91   2              Key_Delay(100);
  92   2          }
  93   1          Key_Delay(100); // 额外延时确保稳定
  94   1      }
  95          
  96          /**
  97           * @brief 获取按键并处理显示
  98           * @param 无
  99           * @return 无
 100           * @说明 主功能函数：按下无现象，松手显示对应编号
 101           */
 102          void MatrixKey_ProcessKey(void)
 103          {
 104   1          static unsigned char last_key = 0;
 105   1          unsigned char current_key;
 106   1          
 107   1          // 检测当前按键状态
 108   1          current_key = MatrixKey_RowScan();
 109   1          
 110   1          if(current_key != 0)
 111   1          {
 112   2              // 有按键按下，记录按键值但不显示
 113   2              last_key = current_key;
 114   2          }
 115   1          else if(last_key != 0)
 116   1          {
C51 COMPILER V9.54   MATRIXKEY                                                             10/02/2025 14:02:12 PAGE 3   

 117   2              // 按键从按下变为释放，显示对应编号
 118   2              KeyDisplayValue = last_key;
 119   2              
 120   2              // 重置last_key，避免重复触发
 121   2              last_key = 0;
 122   2              
 123   2              // 确保按键完全释放
 124   2              MatrixKey_WaitRelease();
 125   2          }
 126   1      }
 127          
 128          /**
 129           * @brief 获取要显示的按键值
 130           * @param 无
 131           * @return 要显示的按键编号 (0-16)
 132           * @说明 返回0表示无显示，1-16表示对应按键编号
 133           */
 134          unsigned char MatrixKey_GetDisplayValue(void)
 135          {
 136   1          unsigned char temp = KeyDisplayValue;
 137   1          KeyDisplayValue = 0; // 读取后清零，避免重复显示
 138   1          return temp;
 139   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    162    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
